<!doctype html>
<!--[if IE 9]>
<html class="lt-ie10" lang="en"> <![endif]-->
<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Scaling Kafka</title>
        <meta name="description" content="Gérald's technical blog about Java, Kafka, Elasticsearch, DevOps...">
        <meta name="author" content="Gérald Quintana">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="/css/coderay.css">
        <link rel="stylesheet" href="/css/asciidoc2.css">
        <link rel="stylesheet"
              href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/default.min.css">
    </head>
    <body>
        <header class="container sticky-top">
            <nav class="navbar navbar-expand-md navbar-dark bg-dark">
                 <a class="navbar-brand" href="/"><h1>JRald blog</h1></a>
                 <h2>
                     <a href="https://twitter.com/gerald_quintana"><i class="fa fa-twitter"></i></a>
                     <a href="https://github.com/gquintana"><i class="fa fa-github"></i></a>
                     <a href="/feed.xml"><i class="fa fa-rss"></i></a>
                 </h2>
            </nav>
        </header>
        <main class="container position-relative " role="main">
            <div>
    <h1>Scaling Kafka</h1>
    <div>
        <img class="rounded float-right" src="../../../images/logos/kafka.png"/>
        <h5>
            <span>2016-10-17</span>
            <span class="badge badge-secondary">kafka</span> 
        </h5>

        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In my previous article about Kafka, I introduced some basic concepts,
and showed how to use this message broker using the Java client API.</p>
</div>
<div class="paragraph">
<p>In this article I will tackle an operational need: adding and removing nodes in a Kafka 0.10.0 cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating_a_topic">Creating a topic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will start with a cluster made of 3 nodes identified 0, 1 and 2.
We first create a topic using the <code>kafka-topics.sh</code> tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ bin/kafka-topics.sh --zookeeper zkhost:2181 --create --topic test_topic --partitions 5 --replication-factor 2
Created topic &quot;test_topic&quot;.

$ bin/kafka-topics.sh --zookeeper zkhost:2181 --describe --topic test_topic
Topic:test_topic        PartitionCount:5        ReplicationFactor:2     Configs:
        Topic: test_topic       Partition: 0    Leader: 2       Replicas: 2,0   Isr: 2,0
        Topic: test_topic       Partition: 1    Leader: 0       Replicas: 0,1   Isr: 0,1
        Topic: test_topic       Partition: 2    Leader: 1       Replicas: 1,2   Isr: 1,2
        Topic: test_topic       Partition: 3    Leader: 2       Replicas: 2,1   Isr: 2,1
        Topic: test_topic       Partition: 4    Leader: 0       Replicas: 0,2   Isr: 0,2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our first topic has 5 partitions and a replication factor of 2
which means 10 partitions will be distributed on our 3 nodes cluster.
As you can see leader partitions and replicas are distributed homogeneously on the nodes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="2016-10-17-Scaling-Kafka/kafka-create-topic.svg" alt="Creating a topic">
</div>
</div>
<div class="paragraph">
<p>All the topic configuration is stored in Zookeeper, which makes it available to all Kafka.
This why in all the commands we will use to manage topics and their partitions there is a <code>--zookeeper</code> argument.
You can use the <code>zookeeper-shell.sh</code> tool to dig in Zookeeper tree:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ bin/zookeeper-shell.sh zkhost:2181
Connecting to zkhost:2181
Welcome to ZooKeeper!

ls /brokers/topics
[__consumer_offsets,test_topic]

get /brokers/topics/test_topic
{&quot;version&quot;:1,&quot;partitions&quot;:{&quot;4&quot;:[0,2],&quot;1&quot;:[0,1],&quot;0&quot;:[2,0],&quot;2&quot;:[1,2],&quot;3&quot;:[2,1]}}

ls /brokers/topics/test_topic/partitions
[0, 1, 2, 3, 4]

get /brokers/topics/test_topic/partitions/0/state
{&quot;controller_epoch&quot;:1,&quot;leader&quot;:2,&quot;version&quot;:1,&quot;leader_epoch&quot;:0,&quot;isr&quot;:[2,0]}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding_a_broker_node">Adding a broker node</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we will add a fourth node with Id 3 to our cluster.
Once the node is started and has successfully joined the cluster,
it doesn&#8217;t automatically receive partitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ bin/kafka-topics.sh --zookeeper zkhost:2181 --describe --topic test_topic
Topic:test_topic        PartitionCount:5        ReplicationFactor:2     Configs:
        Topic: test_topic       Partition: 0    Leader: 2       Replicas: 2,0   Isr: 0,2
        Topic: test_topic       Partition: 1    Leader: 0       Replicas: 0,1   Isr: 1,0
        Topic: test_topic       Partition: 2    Leader: 1       Replicas: 1,2   Isr: 1,2
        Topic: test_topic       Partition: 3    Leader: 2       Replicas: 2,1   Isr: 1,2
        Topic: test_topic       Partition: 4    Leader: 0       Replicas: 0,2   Isr: 0,2</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we will have to redistribute partitions on the 4 nodes.
In fact, our cluster has 2 topics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ bin/kafka-topics.sh --zookeeper zkhost:2181 --list
__consumer_offsets
test_topic</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>test_topic</code> is the topic we created above</p>
</li>
<li>
<p><code>__consumer_offsets</code> is an internal topic used to track consumer offsets.
It has 5 partitions and a replication factor of 3:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ bin/kafka-topics.sh --zookeeper zkhost:2181 --describe --topic __consumer_offsets
Topic:__consumer_offsets        PartitionCount:5        ReplicationFactor:3     Configs:segment.bytes=104857600,cleanup.policy=compact,compression.type=producer
        Topic: __consumer_offsets       Partition: 0    Leader: 0       Replicas: 0,3,1 Isr: 0,3,1
        Topic: __consumer_offsets       Partition: 1    Leader: 1       Replicas: 1,0,2 Isr: 1,0,2
        Topic: __consumer_offsets       Partition: 2    Leader: 2       Replicas: 2,1,3 Isr: 2,1,3
        Topic: __consumer_offsets       Partition: 3    Leader: 3       Replicas: 3,2,0 Isr: 3,2,0
        Topic: __consumer_offsets       Partition: 4    Leader: 0       Replicas: 0,1,2 Isr: 0,1,2</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to write a JSON file to list the topics we want to reorganize:
<code>test_topic</code> and <code>__consumer_offsets</code> in our case:</p>
</div>
<div class="listingblock">
<div class="title">topics.json</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{ <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">topics</span><span class="delimiter">&quot;</span></span>: [
     {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>},
     {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>}
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can use the <code>kafka-reassign-partitions.sh</code> tool to generate partition assignments.
It takes the topic list and the broker list as input, and produces the assignment plan in JSON format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ bin/kafka-reassign-partitions.sh --zookeeper zkhost:2181 --generate --topics-to-move-json-file topics.json --broker-list 0,1,2,3
Current partition replica assignment

{&quot;version&quot;:1,&quot;partitions&quot;:[{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[2,0]},{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[0,2]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[0,3,1]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[3,2,0]},{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[2,1]},{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[1,2]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[0,1,2]},{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[0,1]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[2,1,3]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[1,0,2]}]}
Proposed partition reassignment configuration

{&quot;version&quot;:1,&quot;partitions&quot;:[{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[3,0]},{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[3,1]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[0,1,2]},{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[1,2]},{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[2,3]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[3,0,1]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[0,2,3]},{&quot;topic&quot;:&quot;test_topic&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[0,1]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[1,2,3]},{&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[2,3,0]}]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s use the above proposed reassignment plan, format it a bit to make it more readable,
and save it in a <code>reassignment.json</code> file:</p>
</div>
<div class="listingblock">
<div class="title">reassignment.json</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{ <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">partitions</span><span class="delimiter">&quot;</span></span>:[
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">0</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">3</span>,<span class="integer">0</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">0</span>,<span class="integer">1</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">1</span>,<span class="integer">2</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">3</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">2</span>,<span class="integer">3</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">4</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">3</span>,<span class="integer">1</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">0</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">0</span>,<span class="integer">1</span>,<span class="integer">2</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">0</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">3</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">3</span>,<span class="integer">0</span>,<span class="integer">1</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">4</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">0</span>,<span class="integer">2</span>,<span class="integer">3</span>]}
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The aim of this file is to tell on which node each partition (leader or replica) must be located.
You can check in this assignment plan that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All 4 nodes 0, 1, 2 and 3 are used,</p>
</li>
<li>
<p>Each node has roughly the number of partitions: 6 or 7 (= (2&times;5 + 3&times;5) &div; 4)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To run this plan, we will use the <code>kafka-reassign-partitions.sh</code> tool with the <code>--execute</code> command.
It takes the generated <code>reassignment.json</code> file as input.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bin/kafka-reassign-partitions.sh --zookeeper zkhost:2181 --execute --reassignment-json-file reassignment.json
Current partition replica assignment

{"version":1,"partitions":[{"topic":"test_topic","partition":0,"replicas":[2,0]},{"topic":"test_topic","partition":4,"replicas":[0,2]},{"topic":"__consumer_offsets","partition":0,"replicas":[0,3,1]},{"topic":"__consumer_offsets","partition":3,"replicas":[3,2,0]},{"topic":"test_topic","partition":3,"replicas":[2,1]},{"topic":"test_topic","partition":2,"replicas":[1,2]},{"topic":"__consumer_offsets","partition":4,"replicas":[0,1,2]},{"topic":"test_topic","partition":1,"replicas":[0,1]},{"topic":"__consumer_offsets","partition":2,"replicas":[2,1,3]},{"topic":"__consumer_offsets","partition":1,"replicas":[1,0,2]}]}

Save this to use as the --reassignment-json-file option during rollback
Successfully started reassignment of partitions {"version":1,"partitions":[{"topic":"__consumer_offsets","partition":4,"replicas":[0,2,3]},{"topic":"__consumer_offsets","partition":3,"replicas":[3,0,1]},{"topic":"__consumer_offsets","partition":0,"replicas":[0,1,2]},{"topic":"test_topic","partition":4,"replicas":[3,1]},{"topic":"test_topic","partition":3,"replicas":[2,3]},{"topic":"test_topic","partition":2,"replicas":[1,2]},{"topic":"test_topic","partition":0,"replicas":[3,0]},{"topic":"__consumer_offsets","partition":2,"replicas":[2,3,0]},{"topic":"test_topic","partition":1,"replicas":[0,1]},{"topic":"__consumer_offsets","partition":1,"replicas":[1,2,3]}]}</pre>
</div>
</div>
<div class="paragraph">
<p>You should be aware that you can not execute an assignment plan containing a dead or stopped node.
The assignment can only be executed if mentioned brokers are alive.</p>
</div>
<div class="paragraph">
<p>Once the reassignment is finished, your partitions have been redistributed over the cluster:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="2016-10-17-Scaling-Kafka/kafka-add-node.svg" alt="Adding a node">
</div>
</div>
<div class="paragraph">
<p>It may take a lot of time to move partitions from one node to another when the partitions are fat.
To check the partition reassignment, you can either use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>kafka-reassign-partitions.sh</code> tool with the <code>--verify</code> command.</p>
</li>
<li>
<p>The <code>kafka-topic.sh</code> tool with the <code>--describe</code> command.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bin/kafka-reassign-partitions.sh --zookeeper zkhost:2181 --verify --reassignment-json-file reassignment.json
Status of partition reassignment:
Reassignment of partition [__consumer_offsets,4] completed successfully
Reassignment of partition [__consumer_offsets,3] completed successfully
Reassignment of partition [__consumer_offsets,0] completed successfully
Reassignment of partition [test_topic,4] completed successfully
Reassignment of partition [test_topic,3] completed successfully
Reassignment of partition [test_topic,2] is still in progress
Reassignment of partition [test_topic,0] completed successfully
Reassignment of partition [__consumer_offsets,2] completed successfully
Reassignment of partition [test_topic,1] is still in progress
Reassignment of partition [__consumer_offsets,1] completed successfully

$ bin/kafka-topics.sh --zookeeper zkhost:2181 --describe --topic test_topic
Topic:test_topic        PartitionCount:5        ReplicationFactor:2     Configs:
        Topic: test_topic       Partition: 0    Leader: 3       Replicas: 3,0   Isr: 0,3
        Topic: test_topic       Partition: 1    Leader: 0       Replicas: 0,1   Isr: 1,0
        Topic: test_topic       Partition: 2    Leader: 1       Replicas: 1,2   Isr: 1,2
        Topic: test_topic       Partition: 3    Leader: 2       Replicas: 2,3   Isr: 2,3
        Topic: test_topic       Partition: 4    Leader: 3       Replicas: 3,1   Isr: 3,1</pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, the tools available to monitor this reassignment are scarce,
and you have no clue about how much it will take to end.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="removing_a_broker_node">Removing a broker node</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The recipe to remove a node is very similar to the previous one:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>kafka-topic.sh --list</code> to get the topic list and write a <code>topics.json</code></p>
</li>
<li>
<p><code>kafka-reassign-partitions.sh --generate</code> to generate an assignment plan <code>assignment.json</code> excluding the node to remove</p>
</li>
<li>
<p><code>kafka-reassign-partitions.sh --execute</code> to run the assignment plan</p>
</li>
<li>
<p><code>kafka-reassign-partitions.sh --verify</code> to check whether the assignment plan is applied</p>
</li>
<li>
<p>Stop the broker and remove it</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As an example, we will remove the broker with Id 1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bin/kafka-reassign-partitions.sh --zookeeper zkhost:2181 --generate --topics-to-move-json-file topics.json --broker-list 0,2,3</pre>
</div>
</div>
<div class="paragraph">
<p>The tool proposes the following reassignement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{ <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">partitions</span><span class="delimiter">&quot;</span></span>:[
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">0</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">0</span>,<span class="integer">2</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">2</span>,<span class="integer">3</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">3</span>,<span class="integer">0</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">3</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">0</span>,<span class="integer">3</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">test_topic</span><span class="delimiter">&quot;</span></span>,        <span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">4</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">2</span>,<span class="integer">0</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">0</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">0</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">3</span>,<span class="integer">0</span>,<span class="integer">2</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">0</span>,<span class="integer">2</span>,<span class="integer">3</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">3</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">2</span>,<span class="integer">0</span>,<span class="integer">3</span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">__consumer_offsets</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span>:<span class="integer">4</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">replicas</span><span class="delimiter">&quot;</span></span>:[<span class="integer">3</span>,<span class="integer">2</span>,<span class="integer">0</span>]}
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once executed, the topic is reorganized like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ bin/kafka-topics.sh --zookeeper zkhost:2181 --describe --topic test_topic
Topic:test_topic        PartitionCount:5        ReplicationFactor:2     Configs:
        Topic: test_topic       Partition: 0    Leader: 0       Replicas: 0,2   Isr: 0,2
        Topic: test_topic       Partition: 1    Leader: 2       Replicas: 2,3   Isr: 2,3
        Topic: test_topic       Partition: 2    Leader: 3       Replicas: 3,0   Isr: 0,3
        Topic: test_topic       Partition: 3    Leader: 0       Replicas: 0,3   Isr: 3,0
        Topic: test_topic       Partition: 4    Leader: 2       Replicas: 2,0   Isr: 0,2</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="2016-10-17-Scaling-Kafka/kafka-remove-node.svg" alt="Removing a node">
</div>
</div>
<div class="paragraph">
<p>As you may observe in this example, the data movement between nodes for the partitions of the <code>test_topic</code> is not optimal.
As a result, a hand written assignment may sometimes be preferable over the generated one.</p>
</div>
<div class="paragraph">
<p>To replace a node by another one, you don&#8217;t need to use the above scenarios
because you can keep the same partition assignment.
All you have to do is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop the old node</p>
</li>
<li>
<p>Give the new node the same Id as the old one</p>
</li>
<li>
<p>Start the new node</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rack_awareness">Rack awareness</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Starting with version 0.10.0, Kafka supports rack aware replica placement.
It means Kafka will try to place replicas in different racks (or availability zones).</p>
</div>
<div class="paragraph">
<p>The only change is the <code>broker.rack</code> property in the broker configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">broker.id=0
broker.rack=A</code></pre>
</div>
</div>
<div class="paragraph">
<p>For instance, imagine brokers 0 and 1 are in rack A, while brokers 2 and 3,
are in rack B.
Now, let&#8217;s create a topic with a replication factor two,
each partition has a replica in each rack.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ bin/kafka-topics.sh --zookeeper zkhost:2181 --create --topic test_topic --partitions 5 --replication-factor 2
Created topic &quot;test_topic&quot;.

$ bin/kafka-topics.sh --zookeeper zkhost:2181 --describe --topic test_topic
Topic:test_topic        PartitionCount:5        ReplicationFactor:2     Configs:
        Topic: test_topic       Partition: 0    Leader: 1       Replicas: 1,3   Isr: 1,3
        Topic: test_topic       Partition: 1    Leader: 3       Replicas: 3,0   Isr: 3,0
        Topic: test_topic       Partition: 2    Leader: 0       Replicas: 0,2   Isr: 0,2
        Topic: test_topic       Partition: 3    Leader: 2       Replicas: 2,1   Isr: 2,1
        Topic: test_topic       Partition: 4    Leader: 1       Replicas: 1,2   Isr: 1,2</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="2016-10-17-Scaling-Kafka/kafka-rack.svg" alt="Rack awareness">
</div>
</div>
<div class="paragraph">
<p>This feature is really interesting to improve failure tolerance,
but it makes the assignment harder to build manually.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="simple_scaling">Simple scaling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you have seen it, horizontally scaling a Kafka cluster is not that hard, but it is tedious.</p>
</div>
<div class="paragraph">
<p>Kafka Manager allows, through its web UI, to visually reassign partitions to nodes.</p>
</div>
<div class="paragraph">
<p>Running on a highly elastic environment, like a Docker cluster scheduler, seems sensitive.
Some solutions exist though:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Confluent Enterprise 3.1</strong> contains a feature called <a href="http://www.confluent.io/product/auto-data-balancing/">Auto data balancing</a>
whose purpose is to ease these operations.
Unfortunately, it is not open source.</p>
</li>
<li>
<p><strong>Mesos</strong> has an <a href="https://github.com/mesos/kafka">integration</a> which seems to be able to make <a href="https://docs.mesosphere.com/1.9/usage/service-guides/kafka/">Kafka scaling smoother</a></p>
</li>
</ul>
</div>
</div>
</div>
    </div>
    <div class="clearfix">
        <h4>Other posts</h4>
        <ul>
            
                <li>2020-11-28
                    <a href="/2020/11/28/Build-your-own-CA-with-Ansible.html">Build your own CA with Ansible</a>
                </li>
            
                <li>2020-01-16
                    <a href="/2020/01/16/Retrieving-Kafka-lag.html">Retrieving Kafka Lag</a>
                </li>
            
                <li>2020-01-10
                    <a href="/2020/01/10/Home-temperature-monitoring.html">Home temperature monitoring</a>
                </li>
            
                <li>2019-12-10
                    <a href="/2019/12/10/Kafka-connect-plugin-install.html">Kafka connect plugin install</a>
                </li>
            
                <li>2019-07-03
                    <a href="/2019/07/03/Kafka-integration-tests.html">Kafka integration tests</a>
                </li>
            
        </ul>
    </div>
</div>

        </main>
        <footer class="footer text-muted">
            <div class="container">
                <p class="float-right">
                    <a href="#"><i class="fa fa-arrow-up" aria-hidden="true"></i>
 Back to top</a>
                </p>
                <p>Made with <i class="fa fa-heart" aria-hidden="true"></i> by Gérald Quintana</p>
        </footer>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
